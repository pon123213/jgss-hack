[トップページに戻る](../README.ja.md) | [前回の入門](plugin-dev-02.ja.md)

# RPGツクールMV プラグイン作成入門 (3)

RPGツクールMV で利用する JavaScript ベースの Game Scripting System (JGSS) で記述したプラグイン作成のための入門資料っぽい何か、です。 JS(JavaScript)の基本知識がある方が対象です。

## 前回のまとめ

[作成入門 (1)](plugin-dev-01.ja.md) と [作成入門 (2)](plugin-dev-02.ja.md) では、アクターやエネミーの名前の後にIDを追加表示する、シンプルなプラグインを完成しました。  [RTK_ShowID.js](RTK_ShowID.js) で完成したソースコードを参照できます。

今回はプラグイン開発の際によく使う、Tips的な事柄を幾つか紹介します。

## グローバル変数の定義

これまで説明してきた範囲では、プラグインのコードは全て以下の関数スコープ内で記述してきました。 外部とはプラグインコマンドのみでやりとりしていました。

```js
(function(_global) {
  	// ここにプラグイン処理を記載
})(this);
```

しかしプラグインの提供するサービスによっては、関数や変数値に直接アクセスできたほうが便利なことがあります。 この場合にはあえて、グローバル変数として定義します。

グローバル変数の場合、他プラグインとの競合を避けるためにも、ユニークな名前付けが重要です。 しかし多くのユニークな名前を考えるのは大変なので、通常は 「ひとつのユニークなグローバル変数(オブジェクト)」 を定義します。 そして提供する関数や変数は、そのグローバルオブジェクトの要素として実装していきます。

例えば僕の作成しているJGGSプラグインは、全てファイル名が RTK で始まります。 そして共通で RTK というグローバル変数を定義し、利用するようにしています。 いまのところ RTK が他のプラグインと被ったことはないですし、もしこれから多くの方に使っていただけるとしたら、将来も被る危険性は少なそうです。

また通常、同じ名前のプラグインは同時に読み込まれませんので、プラグインと同名のグローバル変数を定義するのも良いでしょう。

今回はサンプルとして "RTK_Sample" というグローバルオブジェクトを定義してみます。 わかりやすいコードとしては、以下があるでしょう。

```js
var RTK_Sample = {};
(function(_global) {
  	// ここにプラグイン処理を記載
})(this);
```

またプラグイン処理と同じ場所に定義を記述することもできます。 \_global 変数が提供されていることを利用して、以下のように記載します。

```js
(function(_global) {
  	// ここにプラグイン処理を記載
    _global["RTK_Sample"] = {};
})(this);
```

更に細かく言えば、この同じ名前を他のプラグインで定義している可能性もゼロではないので、より安全なコードは以下になります。

```js
(function(_global) {
  	// ここにプラグイン処理を記載
    _global["RTK_Sample"] = _global["RTK_Sample"] || {};
})(this);
```

今回はより安全な、このコードを利用しましょう。

## 前提となるプラグインをチェックする

あるプラグインを作成するとき、事前に別のプラグインが導入されていることを前提とする場合があります。

例えば僕のアイテム・武器・防具の合成を実現するプラグイン [RTK1_Composite](../RTK1_Composite.ja.md) は、開発をサポートする [RTK1_Core](../RTK1_Core.ja.md) プラグインを前提としています。

RTK1_Core プラグインは RTK というグローバルオブジェクトを定義しますので、RTK1_Composite 側では、プラグインの最初で以下のように RTKオブジェクトの存在を確認しています。 もし存在していなければ、その旨をエラー処理(Errorオブジェクトを生成してthrowする)して終了するようになっています。

```js
  if (!_global["RTK"]) {
    throw new Error('This plugin requires RTK1_Core plugin previously.');
  }
```

ここは \_global 引数が役立つ場面で、以下のように単に if 文で存在チェックすると、RTK が存在しない場合に変数の未定義でエラーになってしまいます。

```js
  if (!RTK) {
    throw new Error('This plugin requires RTK1_Core plugin previously.');
  }
```

しかしこの方法は、グローバル領域に何か定義するプラグインを前提としています。 グローバル領域に何も痕跡を残さない「上品な」プラグインの場合には、検出に少し工夫が必要です。 まずは以下の関数をみてください。

```js
PluginManager.parameters = function(name) {
    return this._parameters[name.toLowerCase()] || {};
};
```

この関数から以下の3点がわかります。

* PluginManager.\_parameters にプラグインのパラメータが保存されている
* プラグイン名は小文字に変換されて参照に利用される
* PluginManager.parameters 関数はエラー時に空オブジェクト{}を返すので確認には不向き

よい機会ですから、上記の関数をベースに、プラグインの導入を確認する関数に書き換えてみましょう。 そして今回のプラグインでその関数を提供してみましょう。

```js
(function(_global) {
  	// ここにプラグイン処理を記載
    _global["RTK_Sample"] = _global["RTK_Sample"] || {};
    RTK_Sample.hasPlugin = function(_name){
      return !!PluginManager._parameters[_name.toLowerCase()];      
    }
})(this);
```

この関数(RTK_Sample.hasPlugin)を使えば、前提となるプラグインが導入済みかどうかを簡単に調べることができます。 前回作成した RTK_ShowID プラグインが導入されているかを、コンソールから確認してみましょう。

![Screen shot - console](i/plugin-dev-03-01.png)

## セクション名

書き途中


[トップページに戻る](../README.ja.md) | [前回の入門](plugin-dev-02.ja.md)
