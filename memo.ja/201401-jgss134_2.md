[トップページに戻る](../README.ja.md) | [JGSS 技術メモ](index.md)

# JGSS ver1.2.0 から ver1.3.4 への変化 (中編)

ちょっと離れている間に、JGSS が ver1.3.4 まで進化していました。コードの主要部分を眺めて、違いをざっと把握してみましょう。

[前編](201401-jgss134.md) は plugins.js と rpg_core.js が対象で、今回は rpg_sprites.js が対象の中編です。

## rpg_sprites.js

pixi.js の Sprite を拡張する表示用のクラスですね。中間層なので変化は少なそうです。

### 主な修正点

Sprite では false だった \_isPicture ですが、Sprite_Picture では true に変更(上書き)されています。

```js
Sprite_Picture.prototype.initialize = function(pictureId) {
    Sprite.prototype.initialize.call(this);
    this._pictureId = pictureId;
    this._pictureName = '';
    this._isPicture = true; // 追加された処理
    this.update();
};
```

[前編 ブレンド処理の高速化](201401-jgss134.md#dirty-の独自実装とブレンド処理の高速化) に出てきました。WebGL で描画されるとき、Sprite と Sprite_Picture は異なったレンダリングされ、それを分けるために \_isPicture を加えたよ、と。Picture 用の Sprite はちょっと重めでもきちんとブレンドされる描画モードを使いましょう、ということでしょうかね。


また Spriteset_Map の createTilemap メソッドで、描画モードによって Tilemap のクラスを分けるようになりました。今回 rpg_core.js で新しく追加された [前編 ShaderTilemap クラス](201401-jgss134.md#ShaderTilemap クラス) ですね。

```js
Spriteset_Map.prototype.createTilemap = function() {
    if (Graphics.isWebGL()) {
        this._tilemap = new ShaderTilemap();  // 追加された処理
    } else {
        this._tilemap = new Tilemap();
    }
    // 以下略
};
```

同じく Spriteset_Map クラスの loadTileset メソッドで、以前は毎回実施していた \_tilemap.refresh() を、条件をみて実施するようになりました。無駄な処理を省く工夫だとおもわれます。

```js
Spriteset_Map.prototype.loadTileset = function() {
    this._tileset = $gameMap.tileset();
    if (this._tileset) {
        var tilesetNames = this._tileset.tilesetNames;
        for (var i = 0; i < tilesetNames.length; i++) {
            this._tilemap.bitmaps[i] = ImageManager.loadTileset(tilesetNames[i]);
        }
        var newTilesetFlags = $gameMap.tilesetFlags();
        this._tilemap.refreshTileset();
        if (!this._tilemap.flags.equals(newTilesetFlags)) {  // この条件判断が追加
            this._tilemap.refresh();
        }
        this._tilemap.flags = newTilesetFlags;
    }
};
```

それぞれ地味な改善にみえますが、こういった部分を場合分け、最適化することで全体のパフォーマンスって変わってくるんですよね。頑張っていただきたいです。

### その他

Sprite_Animation クラスに \_reduceArtifacts 属性が追加されているけど、例によって他で見つかりません… 謎ですね。

```js
Sprite_Animation.prototype.initialize = function() {
    Sprite.prototype.initialize.call(this);
    this._reduceArtifacts = true;  // 追加された属性
    this.initMembers();
};
```




[トップページに戻る](../README.ja.md) | [JGSS 技術メモ](index.md)
